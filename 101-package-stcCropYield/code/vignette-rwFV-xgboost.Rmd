---
title: "Early-Season Crop Yield Prediction via XGBoost and Rolling Window Forward Validation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{rwFV-xgboost}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
    )
```
The R package **stcCropYield** implements a number of model training procedures
to build trained prediction models for early-season crop yield (parcel-level)
prediction for the province of Manitoba, using parcel-level NDVI and CARS-level
weather measurement time series as predictor variables.

This vignette demonstrates how to use the function
**stcCropYield::rollingWindowForwardValidation(.)**
to train a crop yield prediction model,
following the *rolling window forward validation* protocol,
using XGBoost as the underlying prediction technique.

First, load the **stcCropYield** R package.
```{r setup}
library(stcCropYield)
```
Next, we generate a synthetic data set in the form of a single data frame
that has the structure expected by
**stcCropYield::rollingWindowForwardValidation(...)**:
```{r synthetic}
set.seed(13);

n.ecoregions    <-    3;
n.crops         <-    5;
n.predictors    <-    7;
avg.n.parcels   <- 1000;
min.num.parcels <-   50;

DF.synthetic <- stcCropYield::getData.synthetic(
    years         = seq(2000,2020),
    n.ecoregions  = n.ecoregions,
    n.crops       = n.crops,
    n.predictors  = n.predictors,
    avg.n.parcels = avg.n.parcels
    )
```
We examine the structure of the data frame DF.synthetic
```{r syntheticStructure}
str(DF.synthetic)
```
The data frame DF.synthetic has `r nrow(DF.synthetic)` rows and
`r ncol(DF.synthetic)` columns.

Each row corresponds to a (reference year, parcel).

As the input data frame to the function
**stcCropYield::rollingWindowForwardValidation**
it must contain the following mandatory columns with the expected data types
(while column names and ordering do NOT matter):

* a numeric column with non-negative integers indicating the reference year
  (in case of DF.synthetic, **my_year**)

* a character column indicating the ecoregion (**my_ecoregion**)

* a character column indicating the crop type (**my_crop**)

* numeric column with non-negative values indicating the evaluation weight
  (**my_evaluation_weight**).
  The usual evaluation weight variable is *seeded area* expressed in *acres*.

* numeric column with non-negative values indicating crop yield (**my_yield**).
  The usual physical unit for crop yield is *number of bushels per acre*.

* a collection of numeric columns of predictor variables
  (in case of DF.synthetic, **x1**, **x2**, ... , **x7**).
  In practice, these could include (but are not limited to)
  the weekly NDVI measurements,
  the weekly (or monthly) weather measurements, and
  their derived variables (e.g. rolling averages, maxima, emerging week, etc).
  There is no limit of the number of predictor variables
  (apart from computer memory).

Here are the first few rows of DF.synthetic:
```{r syntheticHead}
knitr::kable(head(DF.synthetic), align = "c")
```

``` {r}
(predictor.colnames <- grep(x = colnames(DF.synthetic), pattern = "x[0-9]*", value = TRUE))
```

```{r rwFV}
stcCropYield::rollingWindowForwardValidation(
    training.window      = 5,
    validation.window    = 5,
    DF.input             = DF.synthetic,
    year                 = "my_year",
    ecoregion            = "my_ecoregion",
    crop                 = "my_crop",
    response.variable    = "my_yield",
    harvested.area       = "my_harvested_area",
    seeded.area          = "my_seeded_area",
    evaluation.weight    = "my_evaluation_weight",
    predictors           = predictor.colnames,
    min.num.parcels      = min.num.parcels,
    learner              = "xgboost_multiphase",
    by.variables.phase01 = c("my_ecoregion","my_crop"),
    by.variables.phase02 = c("my_crop"),
    by.variables.phase03 = c("my_ecoregion"),
    search.grid = list(
        alpha  = c(1,12,23),
        lambda = c(1,12,23)
        ),
    output.directory = "rwFV",
    log.threshold    = logger::ERROR,
    suppress.child.process.graphics = TRUE
    )
```
We examine the contents in the output direcotry *rwFV*
```{r outputDIR}
list.files("rwFV")
```
The output directory *rwFV* contains:

* three sub-directories:
  * 010-predictions
  * 020-performance-metrics
  * 030-mock-productions

* one RData file: **production-model-RY2021-xgboost_multiphase_9.RData**

* one log file: **rollingWindowForwardValidation.log**

The sub-directory **rwFV/010-predictions** contains the
(hyperparameter,year)-specific parcel-level predictions
as well as rolled up values to the levels of (ecoregion,crop), crop and
ecoregion.

The sub-directory **rwFV/020-performance-metrics** contains the computed performance
metrics according to the aforementioned predictions.

The sub-directory **rwFV/030-productions** contains the prediction error series
in mock production.

The RData file **production-model-RY2021-xgboost_multiphase_9.RData** contains
the final trained model that can be deployed in the next production cycle.

## Contents of **rwFV/010-predictions**
```{r predictions}
list.files(file.path("rwFV","010-predictions"))
```
* **learner-metadata.json**
  JSON file contains metadata about the 9 hyperparameter configurations
  being evaluated

* **xgboost_multiphase_1**, ... , **xgboost_multiphase_9**
  Sub-folders each containing parcel-level prediction results corresponding
  to one of hyperparameter configurations being evaluated

* **xgboost_multiphase_1.log**, ... , **xgboost_multiphase_9.log**
  log files during the fitting/predicting process
  for the hyperparameter configurations being evaluated

The file **rwFV/010-predictions/learner-metadata.json**
contains the specifications of each hyperparameter configuration
in the search grid.
We can see its first 100 lines below:
```{r, echo=FALSE}
learner.metadata.json <- file.path("rwFV","010-predictions","learner-metadata.json")
for ( temp.line in readLines(learner.metadata.json, n = 100) ) { cat(paste0(temp.line),"\n") }
```

Directory structure of **rwFV/010-predictions/xgboost_multiphase_5**
```{r, echo=FALSE}
fs::dir_tree( path = file.path("rwFV","010-predictions","xgboost_multiphase_5") )
```

```{r}
DF.parcel.2013 <- readRDS( file.path("rwFV","010-predictions","xgboost_multiphase_5","2013","predictions-xgboost_multiphase_5-parcel.RData") )
knitr::kable(head(DF.parcel.2013), align = "c")
```

```{r}
DF.parcel.2013.gt01 <- DF.parcel.2013[DF.parcel.2013[,'phase'] > 1,]
knitr::kable(DF.parcel.2013.gt01, align = "c")
```

```{r plotPred2013, out.width="685px"}
knitr::include_graphics(path = file.path("rwFV","010-predictions","xgboost_multiphase_5","2013","plot-predictions-region-crop.png"))
knitr::include_graphics(path = file.path("rwFV","010-predictions","xgboost_multiphase_5","2013","plot-predictions-crop.png"))
knitr::include_graphics(path = file.path("rwFV","010-predictions","xgboost_multiphase_5","2013","plot-predictions-region.png"))
```

```{r metrics}
list.files(file.path("rwFV","020-performance-metrics"))
```

```{r plotMock, out.width="950px"}
knitr::include_graphics(
    path = file.path(
        "rwFV",
        "030-mock-productions",
        "plot-xgboost_multiphase-mockProdErr-vs-year.png"
        )
    )
```
