---
title: "Explanation of contents of output folder of **stcCropYield::rollingWindowForwardValidation(.)**"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{rwFV-xgboost}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
    )
```

This vignette explains the contents of the output folder of the function
**stcCropYield::rollingWindowForwardValidation(.)**.

For documentation on how to use the function, in particular
its input parameters, please consult the vignette
titled "Demo â€“ Crop Yield Prediction via stcCropYield".

Next, we load the **stcCropYield** R package, and then
generate a synthetic data frame with the structure expected by
**stcCropYield::rollingWindowForwardValidation(.)**:
```{r synthetic}
library(stcCropYield)

set.seed(13);

n.ecoregions  <-    3;
n.crops       <-    5;
n.predictors  <-    7;
avg.n.parcels <- 1000;

DF.synthetic <- stcCropYield::getData.synthetic(
    years         = seq(2000,2020),
    n.ecoregions  = n.ecoregions,
    n.crops       = n.crops,
    n.predictors  = n.predictors,
    avg.n.parcels = avg.n.parcels
    )
```
We examine the structure of the data frame DF.synthetic
```{r syntheticStructure}
str(DF.synthetic)
```

Now, we call **stcCropYield::rollingWindowForwardValidation(.)**
to train a parcel-level crop yield prediction model:
```{r rwFV}
stcCropYield::rollingWindowForwardValidation(
    training.window      = 5,
    validation.window    = 5,
    DF.input             = DF.synthetic,
    year                 = "my_year",
    ecoregion            = "my_ecoregion",
    crop                 = "my_crop",
    response.variable    = "my_yield",
    harvested.area       = "my_harvested_area",
    seeded.area          = "my_seeded_area",
    evaluation.weight    = "my_evaluation_weight",
    predictors           = c("x1","x2","x3","x4","x5","x6","x7"),
    min.num.parcels      = 50,
    learner              = "xgboost_multiphase",
    by.variables.phase01 = c("my_ecoregion","my_crop"),
    by.variables.phase02 = c("my_crop"),
    by.variables.phase03 = c("my_ecoregion"),
    search.grid = list(
        alpha  = c(1,12,23),
        lambda = c(1,12,23)
        ),
    output.directory = "rwFV",
    log.threshold    = logger::ERROR,
    suppress.child.process.graphics = TRUE
    )
```
We examine the contents in the output direcotry *rwFV*
```{r outputDIR}
list.files("rwFV")
```
The output directory *rwFV* contains:

* three sub-directories:
  * 010-predictions
  * 020-performance-metrics
  * 030-mock-productions

* one RData file: **production-model-RY2021-xgboost_multiphase_9.RData**

* one log file: **rollingWindowForwardValidation.log**

The sub-directory **rwFV/010-predictions** contains the
(hyperparameter,year)-specific parcel-level predictions
as well as rolled up values to the levels of (ecoregion,crop), crop and
ecoregion.

The sub-directory **rwFV/020-performance-metrics** contains the computed performance
metrics according to the aforementioned predictions.

The sub-directory **rwFV/030-productions** contains the prediction error series
in mock production.

The RData file **production-model-RY2021-xgboost_multiphase_9.RData** contains
the final trained model that can be deployed in the next production cycle.

## Contents of **rwFV/010-predictions**
```{r predictions}
list.files(file.path("rwFV","010-predictions"))
```
* **learner-metadata.json**
  JSON file contains metadata about the 9 hyperparameter configurations
  being evaluated

* **xgboost_multiphase_1**, ... , **xgboost_multiphase_9**
  Sub-folders each containing parcel-level prediction results corresponding
  to one of hyperparameter configurations being evaluated

* **xgboost_multiphase_1.log**, ... , **xgboost_multiphase_9.log**
  log files during the fitting/predicting process
  for the hyperparameter configurations being evaluated

The file **rwFV/010-predictions/learner-metadata.json**
contains the specifications of each hyperparameter configuration
in the search grid.
We can see its first 100 lines below:
```{r, echo=FALSE}
learner.metadata.json <- file.path("rwFV","010-predictions","learner-metadata.json")
for ( temp.line in readLines(learner.metadata.json, n = 100) ) { cat(paste0(temp.line),"\n") }
```

Directory structure of **rwFV/010-predictions/xgboost_multiphase_5**
```{r, echo=FALSE}
fs::dir_tree( path = file.path("rwFV","010-predictions","xgboost_multiphase_5") )
```

```{r}
DF.parcel.2013 <- readRDS( file.path("rwFV","010-predictions","xgboost_multiphase_5","2013","predictions-xgboost_multiphase_5-parcel.RData") )
knitr::kable(head(DF.parcel.2013), align = "c")
```

```{r}
DF.parcel.2013.gt01 <- DF.parcel.2013[DF.parcel.2013[,'phase'] > 1,]
knitr::kable(DF.parcel.2013.gt01, align = "c")
```

```{r plotPred2013, out.width="685px"}
knitr::include_graphics(path = file.path("rwFV","010-predictions","xgboost_multiphase_5","2013","plot-predictions-region-crop.png"))
knitr::include_graphics(path = file.path("rwFV","010-predictions","xgboost_multiphase_5","2013","plot-predictions-crop.png"))
knitr::include_graphics(path = file.path("rwFV","010-predictions","xgboost_multiphase_5","2013","plot-predictions-region.png"))
```

```{r metrics}
list.files(file.path("rwFV","020-performance-metrics"))
```

```{r plotMock, out.width="950px"}
knitr::include_graphics(
    path = file.path(
        "rwFV",
        "030-mock-productions",
        "plot-xgboost_multiphase-mockProdErr-vs-year.png"
        )
    )
```
