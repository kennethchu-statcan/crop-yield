---
title: "Early-Season Crop Yield Prediction via XGBoost and Rolling Window Forward Validation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{name-of-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
The R package **stcCropYield** implements a number of model training procedures
to build trained prediction models for early-season crop yield (parcel-level)
prediction for the province of Manitoba, using parcel-level NDVI and CARS-level
weather measurement time series as predictor variables.

This vignette demonstrates how to use the function
**stcCropYield::rollingWindowForwardValidation(.)**
to train a crop yield prediction model,
following the *rolling window forward validation* protocol,
using XGBoost as the underlying prediction technique.

First, load the **stcCropYield** R package.
```{r setup}
library(stcCropYield)
```
Next, we generate a synthetic data set in the form of a single data frame
that has the structure expected by
**stcCropYield::rollingWindowForwardValidation(...)**:
```{r synthetic}
n.ecoregions <- 3;
n.crops      <- 5;
n.predictors <- 7;

DF.synthetic <- stcCropYield::getData.synthetic(
    #years        = seq(2015,2020),
    years       = seq(2011,2020),
    #years       = seq(2000,2020),
    n.ecoregions = n.ecoregions,
    n.crops      = n.crops,
    n.predictors = n.predictors
    )
```
We examine the structure of the data frame DF.synthetic
```{r syntheticStructure}
str(DF.synthetic)
```
The data frame DF.synthetic has `r nrow(DF.synthetic)` rows and
`r ncol(DF.synthetic)` columns.

Each row corresponds to a (reference year, parcel).

As the input data frame to the function
**stcCropYield::rollingWindowForwardValidation**
it must contain the following mandatory columns with the expected data types
(while column names and ordering do NOT matter):

* a numeric column with non-negative integers indicating the reference year
  (in case of DF.synthetic, **my_year**)

* a character column indicating the ecoregion (**my_ecoregion**)

* a character column indicating the crop type (**my_crop**)

* numeric column with non-negative values indicating the harvested area
  (**my_harvested_area**).  
  The usual physical unit for harvested area is *acre*.

* numeric column with non-negative values indicating crop yield (**my_yield**).  
  The usual physical unit for crop yield is *number of bushels per acre*.

* a collection of numeric columns of predictor variables
  (in case of DF.synthetic, **x1**, **x2**, ... , **x7**).  
  In practice, these could include (but are not limited to)
  the weekly NDVI measurements,
  the weekly (or monthly) weather measurements, and
  their derived variables (e.g. rolling averages, maxima, emerging week, etc).  
  There is no limit of the number of predictor variables
  (apart from computer memory).

Here are the first few rows of DF.synthetic:
```{r syntheticHead}
head(DF.synthetic)
```


```{r rwFV}
stcCropYield::rollingWindowForwardValidation(
    training.window      = 2,
    validation.window    = 3,
    #training.window     =  5,
    #validation.window   = 10,
    DF.input             = DF.synthetic,
    year                 = "my_year",
    ecoregion            = "my_ecoregion",
    crop                 = "my_crop",
    response.variable    = "my_yield",
    harvested.area       = "my_harvested_area",
    predictors           = grep(x = colnames(DF.synthetic), pattern = "x[0-9]*", value = TRUE),
    by.variables.phase01 = c("my_ecoregion","my_crop"),
    by.variables.phase02 = c("my_crop"),
    by.variables.phase03 = c("my_ecoregion"),
    learner     = "xgboost_multiphase",
    search.grid = list(
        alpha       = c(1,12,23),
        lambda      = c(1,12,23),
        lambda_bias = c(23) #seq(23,11,-8)
        ),
    output.directory = "rwFV",
    log.threshold    = logger::ERROR, # logger::DEBUG
    suppress.child.process.graphics = TRUE
    )
```
We examine the contents in the output direcotry *rwFV*
```{r outputDIR}
list.files("rwFV")
```

```{r predictions}
list.files(file.path("rwFV","010-predictions"))
```

```{r metrics}
list.files(file.path("rwFV","020-performance-metrics"))
```

```{r plotMock, out.width="685px"}
knitr::include_graphics(path = file.path("rwFV","030-mock-productions","plot-xgboost_multiphase-mockProdErr-vs-year.png"))
```
